<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quickerch - 第二版Beta</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; padding: 20px; background-size: cover; background-position: center; background-repeat: no-repeat; transition: background 0.8s ease; position: relative; }
        .time-mode { background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url(''); }
        .search-mode { background: linear-gradient(135deg, #1a2980, #26d0ce); }
        .container { text-align: center; max-width: 480px; width: 100%; z-index: 10; position: relative; }
        .main-title { font-size: 40px; color: white; margin-bottom: 8px; font-weight: 800; cursor: pointer; text-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); transform-origin: center; display: inline-flex; align-items: center; }
        .main-title.pressed { transform: translateY(-10px) scale(0.95); }
        .main-title.released { animation: bounceBack 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes bounceBack { 0% { transform: translateY(-10px) scale(0.95); } 50% { transform: translateY(5px) scale(1.02); } 100% { transform: translateY(0) scale(1); } }
        .quick-part { font-weight: 900; background: linear-gradient(90deg, #ffcc00, #fff3cd); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .quick-part span:first-child { color: #ffcc00 !important; }
        .version-badge { margin-left: 12px; font-size: 16px; color: #ffcc00; font-weight: 600; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .sub-title { font-size: 18px; color: rgba(255, 255, 255, 0.8); margin-bottom: 25px; font-weight: 500; }
        #time-display { font-size: 26px; color: white; margin-bottom: 25px; font-weight: 600; text-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        .search-box { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 20px; padding: 18px; box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.18); opacity: 0; transform: translateY(20px); transition: all 0.6s ease; position: relative; z-index: 10; }
        .search-box.visible { opacity: 1; transform: translateY(0); }
        .search-form { display: flex; gap: 10px; margin-bottom: 14px; align-items: center; position: relative; }
        .engine-select-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(255, 255, 255, 0.9); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s ease; z-index: 11; }
        .engine-select-btn img { width: 18px; height: 18px; object-fit: contain; }
        #search-input { flex: 1; padding: 10px 14px; font-size: 14px; border: none; border-radius: 18px; outline: none; background: rgba(255, 255, 255, 0.9); color: #333; font-weight: 500; z-index: 11; }
        #search-btn { padding: 10px 20px; font-size: 14px; background: #3498db; color: white; border: none; border-radius: 18px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; box-shadow: 0 3px 8px rgba(0,0,0,0.15); z-index: 11; }
        #search-btn:hover { background: #2980b9; transform: translateY(-2px); box-shadow: 0 5px 12px rgba(0,0,0,0.2); }
        .engine-dropdown { position: absolute; top: 40px; left: 0; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px 0; display: none; z-index: 100; }
        .engine-dropdown.show { display: block; }
        .engine-dropdown-item { padding: 8px 16px; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: background 0.2s; }
        .engine-dropdown-item:hover { background: #f5f5f5; }
        .engine-dropdown-item img { width: 24px; height: 24px; object-fit: contain; }
        .tabs-container { display: flex; justify-content: center; gap: 8px; margin-top: 18px; flex-wrap: wrap; position: relative; z-index: 10; }
        .tab-item { width: 60px; height: 60px; border-radius: 12px; background: rgba(255, 255, 255, 0.2); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; opacity: 0; transform: scale(0.8); z-index: 10; }
        .tab-item.appear { animation: fadeInScale 0.4s forwards; }
        @keyframes fadeInScale { to { opacity: 1; transform: scale(1); } }
        .tab-item:hover { transform: scale(1.05); background: rgba(255, 255, 255, 0.3); }
        .tab-icon { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; }
        .add-tab-btn { width: 60px; height: 60px; border-radius: 12px; background: rgba(52, 152, 219, 0.3); display: flex; justify-content: center; align-items: center; color: white; font-size: 24px; cursor: pointer; transition: all 0.2s ease; border: 2px dashed rgba(255, 255, 255, 0.5); z-index: 10; }
        .add-tab-btn:hover { background: rgba(52, 152, 219, 0.5); transform: scale(1.05); }
        .context-menu { position: absolute; background: rgba(30, 40, 80, 0.95); backdrop-filter: blur(10px); border-radius: 10px; padding: 8px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; min-width: 120px; display: none; }
        .context-menu-item { padding: 8px 16px; color: white; text-decoration: none; display: block; cursor: pointer; transition: background 0.2s; }
        .context-menu-item:hover { background: rgba(255, 255, 255, 0.15); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 20px; border-radius: 16px; width: 90%; max-width: 380px; }
        .modal h3 { margin-bottom: 14px; color: #2c3e50; text-align: center; font-size: 18px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .modal h3 svg { width: 20px; height: 20px; }
        .modal-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 14px; font-size: 15px; }
        .modal-textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 14px; font-size: 15px; min-height: 100px; resize: none; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 8px; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; }
        .modal-cancel { background: #ecf0f1; color: #2c3e50; }
        .modal-add { background: #3498db; color: white; }
        .modal-danger { background: #e74c3c; color: white; }
        .top-right-hint { position: fixed; top: 20px; right: 20px; color: white; font-size: 15px; opacity: 0.9; text-align: center; z-index: 5; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 20px; backdrop-filter: blur(4px); }
        .test-badge { position: fixed; top: 20px; left: 20px; background: rgba(231, 76, 60, 0.9); color: white; padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; z-index: 100; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .settings-btn { position: fixed; top: 20px; right: 80px; width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s ease; z-index: 100; }
        .settings-btn:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        .settings-icon { width: 22px; height: 22px; object-fit: contain; filter: invert(1); }
        .greeting { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); color: white; font-size: 24px; font-weight: 600; text-shadow: 0 2px 8px rgba(0,0,0,0.3); opacity: 0; transition: opacity 1s ease; z-index: 20; }
        .settings-modal-content { padding: 25px; }
        .setting-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .setting-label { font-size: 16px; color: #2c3e50; display: flex; align-items: center; gap: 8px; }
        .setting-label svg { width: 18px; height: 18px; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3498db; }
        input:checked + .slider:before { transform: translateX(26px); }
        .widgets-drawer { position: fixed; top: 0; right: -320px; width: 300px; height: 100vh; background: rgba(20, 30, 70, 0.95); backdrop-filter: blur(12px); border-left: 1px solid rgba(255, 255, 255, 0.1); padding: 20px 15px; transition: right 0.35s cubic-bezier(0.3, 0, 0, 1); z-index: 90; overflow-y: auto; }
        .widgets-drawer.open { right: 0; }
        .drawer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .drawer-title { color: white; font-size: 20px; font-weight: 600; }
        .widgets-toggle { position: fixed; bottom: 20px; right: 20px; width: 24px; height: 24px; background: #ffcc00; border-radius: 50%; cursor: pointer; z-index: 100; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .widget-preview { background: rgba(255, 255, 255, 0.15); border-radius: 16px; padding: 16px; margin-bottom: 16px; cursor: pointer; transition: transform 0.2s; user-select: none; z-index: 91; position: relative; }
        .widget-preview:hover { transform: scale(1.02); background: rgba(255, 255, 255, 0.25); }
        .widget-preview h4 { color: white; margin-bottom: 12px; font-size: 16px; }
        .widgets-container { position: absolute; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none; z-index: 80; }
        .widget-item { background: rgba(255, 255, 255, 0.2); border-radius: 16px; padding: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 4px 12px rgba(0,0,0,0.15); position: absolute; overflow: hidden; min-width: 180px; min-height: 180px; max-width: 400px; max-height: 400px; pointer-events: auto; transition: all 0.2s ease; z-index: 81; }
        .widget-header { width: 100%; display: flex; justify-content: flex-end; margin-bottom: 8px; }
        .widget-menu-btn { width: 24px; height: 24px; border-radius: 50%; background: rgba(0,0,0,0.2); border: none; color: white; font-size: 12px; cursor: pointer; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.2s; z-index: 82; }
        .widget-item:hover .widget-menu-btn { opacity: 1; }
        .widget-content { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; z-index: 81; }
        .note-widget { width: 100%; height: 100%; background: #fff9c4; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative; transform: rotate(-1deg); z-index: 81; }
        .note-widget:before { content: ''; position: absolute; top: 0; right: 0; width: 30px; height: 30px; background: #ffe082; border-bottom-left-radius: 16px; border-top-right-radius: 8px; }
        .note-widget textarea { width: 100%; height: 100%; background: transparent; border: none; color: #333; padding: 20px 16px 16px; font-size: 15px; resize: none; outline: none; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; z-index: 81; }
        .note-widget textarea::placeholder { color: #795548; }
        .timer-widget { width: 100%; height: 100%; background: transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 81; }
        .timer-display { font-family: 'Digital-7', monospace; font-size: 48px; color: #00e676; text-shadow: 0 0 10px rgba(0,230,118,0.5); padding: 15px 25px; border-radius: 8px; margin-bottom: 20px; letter-spacing: 2px; }
        .timer-controls { display: flex; gap: 12px; justify-content: center; width: 100%; }
        .timer-btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; z-index: 82; }
        .timer-btn.start { background: rgba(102, 187, 106, 0.8); color: white; }
        .timer-btn.reset { background: rgba(239, 83, 80, 0.8); color: white; }
        .timer-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .calendar-widget { width: 100%; height: 100%; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); overflow: auto; z-index: 81; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f5f5f5; }
        .calendar-title { font-size: 20px; font-weight: 600; color: #2c3e50; }
        .calendar-today { background: #ffcc00; color: #2c3e50; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 15px; }
        .calendar-day { color: #7f8c8d; font-size: 14px; text-align: center; font-weight: 500; padding: 8px; }
        .calendar-date { color: #2c3e50; font-size: 16px; text-align: center; padding: 10px; border-radius: 8px; transition: all 0.2s; cursor: pointer; position: relative; }
        .calendar-date.today { background: #3498db; color: white; font-weight: 600; }
        .calendar-date.weekend { color: #e74c3c; }
        .calendar-date:hover { background: #f5f5f5; transform: scale(1.05); }
        .calendar-date.holiday:after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: #e74c3c; border-radius: 50%; }
        .calendar-fortune { background: #f8f9fa; border-radius: 8px; padding: 12px; margin-top: 10px; }
        .fortune-title { font-size: 14px; font-weight: 600; color: #ffcc00; margin-bottom: 6px; }
        .fortune-content { font-size: 13px; color: #7f8c8d; line-height: 1.5; }
        .background-widget { width: 100%; height: 100%; border-radius: 12px; overflow: hidden; position: relative; z-index: 81; }
        .background-widget img { width: 100%; height: 100%; object-fit: cover; }
        .background-widget-nav { position: absolute; bottom: 10px; left: 0; right: 0; display: flex; justify-content: center; gap: 10px; z-index: 82; }
        .background-widget-btn { width: 30px; height: 30px; border-radius: 50%; background: rgba(0,0,0,0.5); color: white; border: none; font-size: 16px; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 82; }
        .widget-resize-handle { position: absolute; bottom: 8px; right: 8px; width: 20px; height: 20px; background: rgba(255,255,255,0.5); border-radius: 4px; cursor: se-resize; display: none; z-index: 82; }
        .widget-resize-handle::after { content: '↘'; color: #333; font-size: 12px; display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; }
        .widget-move-handle { position: absolute; bottom: 8px; right: 35px; width: 20px; height: 20px; background: rgba(255,255,255,0.5); border-radius: 4px; cursor: move; display: none; z-index: 82; }
        .widget-move-handle::after { content: '□'; color: #333; font-size: 10px; display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; }
        .widget-item.resizing .widget-resize-handle { display: block; }
        .widget-item.moving .widget-move-handle { display: block; }
        .widget-context-menu { position: absolute; background: rgba(30, 40, 80, 0.95); backdrop-filter: blur(10px); border-radius: 10px; padding: 8px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 2000; min-width: 120px; display: none; }
        .widget-context-menu-item { padding: 8px 16px; color: white; text-decoration: none; display: block; cursor: pointer; transition: background 0.2s; }
        .widget-context-menu-item.remove { color: #e74c3c; }
        .widget-context-menu-item:hover { background: rgba(255, 255, 255, 0.15); }
        @media (max-width: 600px) {
            .main-title { font-size: 30px; }
            .version-badge { font-size: 14px; margin-left: 8px; }
            .sub-title { font-size: 16px; }
            #time-display { font-size: 20px; }
            .search-form { flex-direction: column; }
            .engine-select-btn { align-self: flex-start; margin-bottom: 8px; }
            #search-btn { width: 100%; }
            .tab-item, .add-tab-btn { width: 50px; height: 50px; }
            .timer-display { font-size: 36px; padding: 12px 20px; }
            .calendar-title { font-size: 18px; }
        }
    </style>
</head>
<body class="time-mode">
    <div class="test-badge">测试版</div>
    <div class="top-right-hint">点击 Quickerch 开始键入世界</div>
    <div class="settings-btn" id="settingsBtn">
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHI9IjkiIHJ4PSIyIiByeT0iMiI+PC9yZWN0PjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEiPjwvY2lyY2xlPjxwYXRoIGQ9Ik0xNiAxMkg4Ij48L3BhdGg+PHBhdGggeD0iMTIiIHk9IjE1Ij48L3BhdGg+PHBhdGggeD0iMTIgOSI+PC9wYXRoPjwvc3ZnPg==" alt="设置" class="settings-icon">
    </div>
    <div class="greeting" id="greeting"></div>
    
    <!-- 小组件抽屉 -->
    <div class="widgets-drawer" id="widgetsDrawer">
        <div class="drawer-header">
            <div class="drawer-title">小组件库</div>
        </div>
        <div class="widget-preview" data-type="note">
            <h4>便签</h4>
            <div style="display:flex;justify-content:center;padding:8px;background:#fff9c4;border-radius:8px;transform:rotate(-1deg);">
                <span style="color:#795548;font-size:14px;">点击添加笔记...</span>
            </div>
        </div>
        <div class="widget-preview" data-type="timer">
            <h4>倒计时计时器</h4>
            <div style="display:flex;justify-content:center;padding:8px;background:transparent;border-radius:8px;">
                <span style="color:#00e676;font-size:18px;font-family:monospace;">00:00:00</span>
            </div>
        </div>
        <div class="widget-preview" data-type="calendar">
            <h4>日历</h4>
            <div style="display:flex;justify-content:center;padding:8px;background:white;border-radius:8px;">
                <span style="color:#2c3e50;font-size:14px;">当前月份日历</span>
            </div>
        </div>
        <div class="widget-preview" data-type="background">
            <h4>Quick背景</h4>
            <div style="display:flex;justify-content:center;padding:8px;background:#f5f5f5;border-radius:8px;overflow:hidden;">
                <img src="/src/bgg2.jpg" width="100%" height="60" object-fit="cover" alt="背景预览">
            </div>
        </div>
    </div>
    
    <!-- 小组件抽屉按钮 -->
    <div class="widgets-toggle" id="widgetsToggle"></div>
    
    <!-- 主容器 -->
    <div class="container">
        <h1 class="main-title" id="quickerchTitle">
            <span class="quick-part"><span>Q</span>uick</span>erch
            <span class="version-badge">第二版Beta</span>
        </h1>
        <h2 class="sub-title">轻起始页</h2>
        <div id="time-display"></div>
    </div>
    
    <!-- 设置模态框 -->
    <div class="modal" id="settingsModal">
        <div class="modal-content settings-modal-content">
            <h3>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                实验性功能设置
            </h3>
            <div class="setting-item">
                <label class="setting-label">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
                    </svg>
                    使用问候语
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" id="greetingToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="closeSettingsBtn">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 添加书签模态框 -->
    <div class="modal" id="addTabModal">
        <div class="modal-content">
            <h3>添加新书签</h3>
            <input type="url" class="modal-input" id="tabUrlInput" placeholder="https://example.com" required>
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="cancelBtn">取消</button>
                <button class="modal-btn modal-add" id="confirmBtn">添加</button>
            </div>
        </div>
    </div>
    
    <!-- 编辑书签模态框 -->
    <div class="modal" id="editTabModal">
        <div class="modal-content">
            <h3>编辑书签</h3>
            <input type="url" class="modal-input" id="editTabUrlInput" placeholder="https://example.com" required>
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="cancelEditBtn">取消</button>
                <button class="modal-btn modal-add" id="saveEditBtn">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 计时器设置模态框 -->
    <div class="modal" id="timerModal">
        <div class="modal-content">
            <h3>设置计时时间（秒）</h3>
            <input type="number" class="modal-input" id="timerSecondsInput" placeholder="输入秒数（1-3600）" min="1" max="3600" required>
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="cancelTimerBtn">取消</button>
                <button class="modal-btn modal-add" id="confirmTimerBtn">确认并开始</button>
            </div>
        </div>
    </div>
    
    <!-- 小组件上下文菜单 -->
    <div class="widget-context-menu" id="widgetContextMenu">
        <div class="widget-context-menu-item" id="resizeWidget">调整大小</div>
        <div class="widget-context-menu-item" id="moveWidget">调整位置</div>
        <div class="widget-context-menu-item" id="setTimer">设置计时</div>
        <div class="widget-context-menu-item" id="setAsBackground">设置为起始页背景</div>
        <div class="widget-context-menu-item" id="setSolidBackground">设置纯色背景</div>
        <div class="widget-context-menu-item remove" id="removeWidget">移除</div>
    </div>

    <script>
        
        const STORAGE_KEYS = {
            TABS: 'quickerch_bookmarks',
            SEARCH_ENGINE: 'quickerch_search_engine',
            GREETING: 'quickerch_greeting_enabled',
            WIDGETS: 'quickerch_widgets',
            BACKGROUND: 'quickerch_background'
        };

        
        const DEFAULT_TABS = [
            { title: 'Bilibili', url: 'https://www.bilibili.com', icon: 'https://static.hdslb.com/mobile/img/bilibili.png' },
            { title: '爱奇艺', url: 'https://www.iqiyi.com', icon: 'https://www.iqiyi.com/favicon.ico' },
            { title: '优酷', url: 'https://www.youku.com', icon: 'https://static.youku.com/v1.0.0531.0/favicon.ico' },
            { title: 'CNDS', url: 'https://www.cndss.com', icon: 'https://www.cndss.com/favicon.ico' }
        ];

        const SEARCH_ENGINES = {
            bing: { name: '必应', url: 'https://www.bing.com/search?q=', icon: 'https://www.bing.com/favicon.ico' },
            baidu: { name: '百度', url: 'https://www.baidu.com/s?wd=', icon: 'https://www.baidu.com/favicon.ico' },
            yandex: { name: 'Yandex', url: 'https://yandex.com/search/?text=', icon: 'https://yandex.com/favicon.ico' }
        };

        const BACKGROUND_IMAGES = ['/src/bg1.jpg','/src/bg2.jpg','/src/bg3.jpg','/src/bg4.jpg','/src/bg5.jpg'];
        const WIDGET_BACKGROUNDS = ['/src/bgg2.jpg', '/src/bgg3.jpg', '/src/bgg4.jpg'];
        const HOLIDAYS = {
            '1-1': '元旦', '2-14': '情人节', '3-8': '妇女节', '3-12': '植树节', '4-1': '愚人节',
            '5-1': '劳动节', '5-4': '青年节', '6-1': '儿童节', '7-1': '建党节', '8-1': '建军节',
            '9-10': '教师节', '10-1': '国庆节', '12-25': '圣诞节'
        };
        const FORTUNES = [
            '今日运势大吉，事事顺心如意！', '今天适合规划未来，会有意外收获~',
            '保持积极心态，困难都会迎刃而解', '财运亨通，注意把握身边的机会',
            '人缘极佳，适合拓展社交圈', '健康运势上升，记得适当运动',
            '今日宜冷静思考，忌冲动决策', '贵人运降临，遇到困难可向他人求助'
        ];

        
        let isSearchMode = false;
        let searchBox = null;
        let widgetsContainer = null;
        let currentEditIndex = -1;
        let currentWidgetIndex = -1;
        let timerIntervals = {};
        let resizeData = null;
        let moveData = null;

        
        function storageGet(key, defaultValue = null) {
            try {
                const value = localStorage.getItem(key);
                return value ? JSON.parse(value) : defaultValue;
            } catch (e) {
                console.error('存储读取失败:', e);
                return defaultValue;
            }
        }

        function storageSet(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error('存储写入失败:', e);
            }
        }

        
        function loadBookmarks() {
            const bookmarks = storageGet(STORAGE_KEYS.TABS);
            if (!bookmarks) {
                storageSet(STORAGE_KEYS.TABS, DEFAULT_TABS);
                return DEFAULT_TABS;
            }
            return bookmarks;
        }

        function saveBookmark(tab) {
            const bookmarks = loadBookmarks();
            bookmarks.push(tab);
            storageSet(STORAGE_KEYS.TABS, bookmarks);
            renderBookmarks();
        }

        function updateBookmark(index, newUrl) {
            try {
                const bookmarks = loadBookmarks();
                const urlObj = new URL(newUrl);
                bookmarks[index] = {
                    title: urlObj.hostname.replace('www.', ''),
                    url: newUrl,
                    icon: `https://www.google.com/s2/favicons?domain=${urlObj.hostname}&sz=64`
                };
                storageSet(STORAGE_KEYS.TABS, bookmarks);
                renderBookmarks();
            } catch (e) {
                alert('URL无效，请输入正确的网址');
                console.error('书签更新失败:', e);
            }
        }

        function deleteBookmark(index) {
            const bookmarks = loadBookmarks();
            bookmarks.splice(index, 1);
            storageSet(STORAGE_KEYS.TABS, bookmarks);
            renderBookmarks();
        }

        function renderBookmarks(container = null) {
            const targetContainer = container || document.querySelector('.tabs-container');
            if (!targetContainer) return;

            targetContainer.innerHTML = '';
            const bookmarks = loadBookmarks();

            bookmarks.forEach((tab, index) => {
                const tabEl = document.createElement('div');
                tabEl.className = 'tab-item';
                tabEl.innerHTML = `<img src="${tab.icon}" alt="${tab.title}" class="tab-icon" onerror="this.src='https://www.google.com/s2/favicons?domain=example.com&sz=64'">`;
                
                
                tabEl.addEventListener('click', () => {
                    window.open(tab.url, '_blank');
                });
                
                tabEl.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showContextMenu(e.clientX, e.clientY, index);
                });
                
                tabEl.addEventListener('touchstart', (e) => {
                    const pressTimer = setTimeout(() => {
                        const rect = tabEl.getBoundingClientRect();
                        showContextMenu(rect.left, rect.bottom + 5, index);
                    }, 2000);
                    
                    tabEl.addEventListener('touchend', () => clearTimeout(pressTimer));
                    tabEl.addEventListener('touchcancel', () => clearTimeout(pressTimer));
                });

                targetContainer.appendChild(tabEl);
                setTimeout(() => tabEl.classList.add('appear'), index * 100);
            });

            const addBtn = document.createElement('div');
            addBtn.className = 'add-tab-btn';
            addBtn.textContent = '+';
            addBtn.addEventListener('click', () => {
                document.getElementById('addTabModal').classList.add('show');
            });
            targetContainer.appendChild(addBtn);
            setTimeout(() => addBtn.classList.add('appear'), bookmarks.length * 100);
        }

        
        function loadSearchEngine() {
            const engine = storageGet(STORAGE_KEYS.SEARCH_ENGINE);
            return engine || 'bing';
        }

        function saveSearchEngine(engine) {
            storageSet(STORAGE_KEYS.SEARCH_ENGINE, engine);
            updateEngineButton(engine);
        }

        function updateEngineButton(engine) {
            const btn = document.querySelector('.engine-select-btn');
            if (btn) {
                btn.innerHTML = `<img src="${SEARCH_ENGINES[engine].icon}" alt="${SEARCH_ENGINES[engine].name}">`;
            }
        }

        function initSearchEngineDropdown() {
            const dropdown = document.createElement('div');
            dropdown.className = 'engine-dropdown';
            Object.entries(SEARCH_ENGINES).forEach(([key, engine]) => {
                const item = document.createElement('div');
                item.className = 'engine-dropdown-item';
                item.innerHTML = `<img src="${engine.icon}" alt="${engine.name}"> ${engine.name}`;
                item.addEventListener('click', () => {
                    saveSearchEngine(key);
                    dropdown.classList.remove('show');
                });
                dropdown.appendChild(item);
            });
            return dropdown;
        }

        
        function loadGreetingSetting() {
            const enabled = storageGet(STORAGE_KEYS.GREETING);
            return enabled === null ? true : enabled;
        }

        function saveGreetingSetting(enabled) {
            storageSet(STORAGE_KEYS.GREETING, enabled);
            document.getElementById('greetingToggle').checked = enabled;
        }

        function getGreetingText() {
            const hour = new Date().getHours();
            return hour >= 6 && hour < 12 ? '早上好！' : hour >= 12 && hour < 18 ? '中午好！' : '晚上好！';
        }

        function showGreeting() {
            const greetingEl = document.getElementById('greeting');
            const isEnabled = loadGreetingSetting();
            if (!isEnabled || !isSearchMode) return;
            greetingEl.textContent = getGreetingText();
            greetingEl.style.opacity = '1';
            setTimeout(() => greetingEl.style.opacity = '0', 3000);
        }

        
        function updateTimeDisplay() {
            const beijingTime = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Shanghai" }));
            document.getElementById('time-display').textContent = beijingTime.toLocaleTimeString('zh-CN', { hour12: false });
        }

        function getRandomBackground() {
            return BACKGROUND_IMAGES[Math.floor(Math.random() * BACKGROUND_IMAGES.length)];
        }

        
        function showContextMenu(x, y, index) {
            let menu = document.getElementById('contextMenu');
            if (!menu) {
                menu = document.createElement('div');
                menu.id = 'contextMenu';
                menu.className = 'context-menu';
                menu.innerHTML = `
                    <div class="context-menu-item" id="editTab">编辑</div>
                    <div class="context-menu-item" id="deleteTab">删除</div>
                `;
                document.body.appendChild(menu);
            }

            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.display = 'block';
            currentEditIndex = index;

            document.getElementById('editTab').onclick = () => {
                menu.style.display = 'none';
                const bookmarks = loadBookmarks();
                document.getElementById('editTabUrlInput').value = bookmarks[index].url;
                document.getElementById('editTabModal').classList.add('show');
            };

            document.getElementById('deleteTab').onclick = () => {
                menu.style.display = 'none';
                deleteBookmark(index);
            };

            document.addEventListener('click', hideContextMenu, { once: true });
        }

        function hideContextMenu() {
            const menu = document.getElementById('contextMenu');
            if (menu) menu.style.display = 'none';
        }

        
        function loadWidgets() {
            const widgets = storageGet(STORAGE_KEYS.WIDGETS);
            return widgets || [];
        }

        function saveWidget(widget) {
            const widgets = loadWidgets();
            const defaultPos = { 
                x: Math.max(20, 50 + (widgets.length * 20)), 
                y: Math.max(20, 50 + (widgets.length * 20)) 
            };
            widgets.push({
                id: Date.now().toString(),
                type: widget.type,
                data: widget.data || (widget.type === 'background' ? { imgIndex: 0 } : {}),
                size: { width: 250, height: 200 },
                pos: defaultPos
            });
            storageSet(STORAGE_KEYS.WIDGETS, widgets);
            renderWidgets();
        }

        function deleteWidget(id) {
            const widgets = loadWidgets().filter(w => w.id !== id);
            storageSet(STORAGE_KEYS.WIDGETS, widgets);
            
            if (timerIntervals[id]) {
                clearInterval(timerIntervals[id]);
                delete timerIntervals[id];
            }
            
            renderWidgets();
        }

        function updateWidgetSize(id, width, height) {
            const widgets = loadWidgets().map(w => 
                w.id === id ? { ...w, size: { width, height } } : w
            );
            storageSet(STORAGE_KEYS.WIDGETS, widgets);
        }

        function updateWidgetPos(id, x, y) {
            const widgets = loadWidgets().map(w => 
                w.id === id ? { ...w, pos: { x, y } } : w
            );
            storageSet(STORAGE_KEYS.WIDGETS, widgets);
        }

        function createNoteWidget(data = { content: '' }) {
            const widget = document.createElement('div');
            widget.className = 'note-widget';
            widget.innerHTML = `<textarea placeholder="输入笔记内容..." oninput="updateNoteContent(this)">${data.content || ''}</textarea>`;
            return widget;
        }

        function createTimerWidget(data = { time: 0, running: false }) {
            const widget = document.createElement('div');
            widget.className = 'timer-widget';
            const timeString = formatTime(data.time || 0);
            widget.innerHTML = `
                <div class="timer-display">${timeString}</div>
                <div class="timer-controls">
                    <button class="timer-btn start" data-action="start">${data.running ? '暂停' : '开始'}</button>
                    <button class="timer-btn reset" data-action="reset">重置</button>
                </div>
            `;
            return widget;
        }

        function createCalendarWidget() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const today = now.getDate();
            const monthStr = month + 1;
            const dateKey = `${monthStr}-${today}`;
            const isHoliday = HOLIDAYS[dateKey];
            const fortune = FORTUNES[Math.floor(Math.random() * FORTUNES.length)];
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const widget = document.createElement('div');
            widget.className = 'calendar-widget';
            const months = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
            widget.innerHTML = `
                <div class="calendar-header">
                    <div class="calendar-title">${year}年 ${months[month]}</div>
                    <div class="calendar-today">今日 ${today}日</div>
                </div>
            `;
            
            const dayNames = ['日', '一', '二', '三', '四', '五', '六'];
            const dayGrid = document.createElement('div');
            dayGrid.className = 'calendar-grid';
            dayNames.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = day;
                dayGrid.appendChild(dayEl);
            });
            
            for (let i = 0; i < firstDay; i++) {
                const emptyEl = document.createElement('div');
                emptyEl.className = 'calendar-date';
                dayGrid.appendChild(emptyEl);
            }
            
            for (let i = 1; i <= daysInMonth; i++) {
                const dateEl = document.createElement('div');
                const dateKey = `${monthStr}-${i}`;
                const isCurrentDate = i === today;
                const isWeekend = new Date(year, month, i).getDay() === 0 || new Date(year, month, i).getDay() === 6;
                const isDateHoliday = HOLIDAYS[dateKey];
                dateEl.className = `calendar-date ${isCurrentDate ? 'today' : ''} ${isWeekend ? 'weekend' : ''} ${isDateHoliday ? 'holiday' : ''}`;
                dateEl.textContent = i;
                if (isDateHoliday) dateEl.title = isDateHoliday;
                dayGrid.appendChild(dateEl);
            }
            
            widget.appendChild(dayGrid);
            const fortuneEl = document.createElement('div');
            fortuneEl.className = 'calendar-fortune';
            fortuneEl.innerHTML = `
                <div class="fortune-title">${isHoliday ? `${isHoliday} · ` : ''}今日运势</div>
                <div class="fortune-content">${fortune}</div>
            `;
            widget.appendChild(fortuneEl);
            return widget;
        }

        function createBackgroundWidget(data = { imgIndex: 0 }) {
            const widget = document.createElement('div');
            widget.className = 'background-widget';
            const imgSrc = WIDGET_BACKGROUNDS[data.imgIndex % WIDGET_BACKGROUNDS.length];
            widget.innerHTML = `
                <img src="${imgSrc}" alt="背景图片">
                <div class="background-widget-nav">
                    <button class="background-widget-btn prev-btn" data-action="prev">&lt;</button>
                    <button class="background-widget-btn next-btn" data-action="next">&gt;</button>
                </div>
            `;
            return widget;
        }

        function renderWidgets() {
            if (!widgetsContainer) createWidgetsContainer();
            widgetsContainer.innerHTML = '';
            const widgets = loadWidgets();
            
            widgets.forEach((widget, index) => {
                const widgetEl = document.createElement('div');
                widgetEl.className = 'widget-item';
                widgetEl.dataset.id = widget.id;
                widgetEl.style.width = `${widget.size.width}px`;
                widgetEl.style.height = `${widget.size.height}px`;
                widgetEl.style.left = `${widget.pos.x}px`;
                widgetEl.style.top = `${widget.pos.y}px`;
                
                widgetEl.innerHTML = `
                    <div class="widget-header">
                        <button class="widget-menu-btn" data-index="${index}">⋮</button>
                    </div>
                    <div class="widget-content" id="widgetContent-${widget.id}"></div>
                    <div class="widget-resize-handle"></div>
                    <div class="widget-move-handle"></div>
                `;
                
                const contentEl = widgetEl.querySelector(`#widgetContent-${widget.id}`);
                switch (widget.type) {
                    case 'note':
                        contentEl.appendChild(createNoteWidget(widget.data));
                        break;
                    case 'timer':
                        contentEl.appendChild(createTimerWidget(widget.data));
                        initTimerWidget(widget.id, widget.data);
                        break;
                    case 'calendar':
                        contentEl.appendChild(createCalendarWidget());
                        break;
                    case 'background':
                        contentEl.appendChild(createBackgroundWidget(widget.data));
                        initBackgroundWidget(widget.id, widget.data);
                        break;
                }
                
                
                const menuBtn = widgetEl.querySelector('.widget-menu-btn');
                menuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentWidgetIndex = index;
                    showWidgetContextMenu(e.clientX, e.clientY, widget.type);
                });
                
                
                initWidgetResize(widgetEl, widget.id);
                initWidgetMove(widgetEl, widget.id);
                
                widgetsContainer.appendChild(widgetEl);
            });
        }

        function initTimerWidget(widgetId, data) {
            const widgetEl = document.querySelector(`.widget-item[data-id="${widgetId}"]`);
            if (!widgetEl) return;
            
            const display = widgetEl.querySelector('.timer-display');
            const startBtn = widgetEl.querySelector('.timer-btn.start');
            const resetBtn = widgetEl.querySelector('.timer-btn.reset');
            
            let time = data.time || 0;
            let running = data.running || false;
            let intervalId = null;
            
           
            if (running && timerIntervals[widgetId]) {
                clearInterval(timerIntervals[widgetId]);
            }
            
            if (running) {
                intervalId = setInterval(() => {
                    if (time <= 0) {
                        clearInterval(intervalId);
                        running = false;
                        startBtn.textContent = '开始';
                        updateTimerData(widgetId, time, running);
                        return;
                    }
                    time--;
                    display.textContent = formatTime(time);
                    updateTimerData(widgetId, time, running);
                }, 1000);
                timerIntervals[widgetId] = intervalId;
            }
            
          
            startBtn.addEventListener('click', () => {
                if (running) {
                    clearInterval(intervalId);
                    running = false;
                    startBtn.textContent = '开始';
                } else {
                    if (time <= 0) {
                        openTimerSettingModal(widgetId, true);
                    } else {
                        running = true;
                        startBtn.textContent = '暂停';
                        intervalId = setInterval(() => {
                            if (time <= 0) {
                                clearInterval(intervalId);
                                running = false;
                                startBtn.textContent = '开始';
                                updateTimerData(widgetId, time, running);
                                return;
                            }
                            time--;
                            display.textContent = formatTime(time);
                            updateTimerData(widgetId, time, running);
                        }, 1000);
                        timerIntervals[widgetId] = intervalId;
                    }
                }
                updateTimerData(widgetId, time, running);
            });
            
            resetBtn.addEventListener('click', () => {
                clearInterval(intervalId);
                running = false;
                time = 0;
                display.textContent = formatTime(time);
                startBtn.textContent = '开始';
                updateTimerData(widgetId, time, running);
            });
        }

        function initBackgroundWidget(widgetId, data) {
            const widgetEl = document.querySelector(`.widget-item[data-id="${widgetId}"]`);
            if (!widgetEl) return;
            
            const imgEl = widgetEl.querySelector('img');
            const prevBtn = widgetEl.querySelector('.prev-btn');
            const nextBtn = widgetEl.querySelector('.next-btn');
            let imgIndex = data.imgIndex || 0;
            
            
            prevBtn.addEventListener('click', () => {
                imgIndex = (imgIndex - 1 + WIDGET_BACKGROUNDS.length) % WIDGET_BACKGROUNDS.length;
                imgEl.src = WIDGET_BACKGROUNDS[imgIndex];
                updateWidgetData(widgetId, { imgIndex });
            });
            
            nextBtn.addEventListener('click', () => {
                imgIndex = (imgIndex + 1) % WIDGET_BACKGROUNDS.length;
                imgEl.src = WIDGET_BACKGROUNDS[imgIndex];
                updateWidgetData(widgetId, { imgIndex });
            });
        }

        
        function initWidgetResize(widgetEl, widgetId) {
            const resizeHandle = widgetEl.querySelector('.widget-resize-handle');
            resizeHandle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const widget = loadWidgets().find(w => w.id === widgetId);
                resizeData = {
                    startX: e.clientX,
                    startY: e.clientY,
                    startWidth: widget.size.width,
                    startHeight: widget.size.height,
                    widgetId
                };
                
                widgetEl.classList.add('resizing');
               
                document.addEventListener('mousemove', handleResize, true);
                document.addEventListener('mouseup', stopResize, true);
            });
        }

        function handleResize(e) {
            if (!resizeData) return;
            e.preventDefault();
            
            const width = Math.min(400, Math.max(180, resizeData.startWidth + (e.clientX - resizeData.startX)));
            const height = Math.min(400, Math.max(180, resizeData.startHeight + (e.clientY - resizeData.startY)));
            
            const widgetEl = document.querySelector(`.widget-item[data-id="${resizeData.widgetId}"]`);
            if (widgetEl) {
                widgetEl.style.width = `${width}px`;
                widgetEl.style.height = `${height}px`;
            }
        }

        function stopResize() {
            if (resizeData) {
                const widgetEl = document.querySelector(`.widget-item[data-id="${resizeData.widgetId}"]`);
                if (widgetEl) {
                    updateWidgetSize(resizeData.widgetId, widgetEl.offsetWidth, widgetEl.offsetHeight);
                    widgetEl.classList.remove('resizing');
                }
                resizeData = null;
            }
            
            document.removeEventListener('mousemove', handleResize, true);
            document.removeEventListener('mouseup', stopResize, true);
        }

        
        function initWidgetMove(widgetEl, widgetId) {
            const moveHandle = widgetEl.querySelector('.widget-move-handle');
            moveHandle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const widget = loadWidgets().find(w => w.id === widgetId);
                moveData = {
                    startX: e.clientX,
                    startY: e.clientY,
                    startPos: { ...widget.pos },
                    widgetId
                };
                
                widgetEl.classList.add('moving');
                document.addEventListener('mousemove', handleMove, true);
                document.addEventListener('mouseup', stopMove, true);
            });
        }

        function handleMove(e) {
            if (!moveData) return;
            e.preventDefault();
            
            const x = moveData.startPos.x + (e.clientX - moveData.startX);
            const y = moveData.startPos.y + (e.clientY - moveData.startY);
            
            
            const maxX = window.innerWidth - 180;
            const maxY = window.innerHeight - 180;
            const constrainedX = Math.max(20, Math.min(maxX, x));
            const constrainedY = Math.max(20, Math.min(maxY, y));
            
            const widgetEl = document.querySelector(`.widget-item[data-id="${moveData.widgetId}"]`);
            if (widgetEl) {
                widgetEl.style.left = `${constrainedX}px`;
                widgetEl.style.top = `${constrainedY}px`;
            }
        }

        function stopMove() {
            if (moveData) {
                const widgetEl = document.querySelector(`.widget-item[data-id="${moveData.widgetId}"]`);
                if (widgetEl) {
                    updateWidgetPos(moveData.widgetId, widgetEl.offsetLeft, widgetEl.offsetTop);
                    widgetEl.classList.remove('moving');
                }
                moveData = null;
            }
            document.removeEventListener('mousemove', handleMove, true);
            document.removeEventListener('mouseup', stopMove, true);
        }

        function openTimerSettingModal(widgetId, autoStart = false) {
            document.getElementById('timerModal').dataset.widgetId = widgetId;
            document.getElementById('timerSecondsInput').value = '';
            document.getElementById('timerModal').classList.add('show');
            
            if (autoStart) {
                document.getElementById('confirmTimerBtn').dataset.autoStart = 'true';
            } else {
                delete document.getElementById('confirmTimerBtn').dataset.autoStart;
            }
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function updateTimerData(widgetId, time, running) {
            const widgets = loadWidgets().map(w => 
                w.id === widgetId ? { ...w, data: { time, running } } : w
            );
            storageSet(STORAGE_KEYS.WIDGETS, widgets);
        }

        function updateWidgetData(widgetId, data) {
            const widgets = loadWidgets().map(w => 
                w.id === widgetId ? { ...w, data } : w
            );
            storageSet(STORAGE_KEYS.WIDGETS, widgets);
        }

        function updateNoteContent(textarea) {
            const widgetEl = textarea.closest('.widget-item');
            const widgetId = widgetEl.dataset.id;
            const widgets = loadWidgets().map(w => 
                w.id === widgetId ? { ...w, data: { content: textarea.value } } : w
            );
            storageSet(STORAGE_KEYS.WIDGETS, widgets);
        }

       
        function showWidgetContextMenu(x, y, widgetType) {
            const menu = document.getElementById('widgetContextMenu');
            const setTimerItem = document.getElementById('setTimer');
            const bgItems = [document.getElementById('setAsBackground'), document.getElementById('setSolidBackground')];
            
            
            setTimerItem.style.display = widgetType === 'timer' ? 'block' : 'none';
            bgItems.forEach(item => item.style.display = widgetType === 'background' ? 'block' : 'none');
            
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.style.display = 'block';
            
            
            document.getElementById('resizeWidget').onclick = () => {
                menu.style.display = 'none';
                const widgets = loadWidgets();
                const widgetEl = document.querySelector(`.widget-item[data-id="${widgets[currentWidgetIndex].id}"]`);
                if (widgetEl) widgetEl.classList.add('resizing');
            };
            
            
            document.getElementById('moveWidget').onclick = () => {
                menu.style.display = 'none';
                const widgets = loadWidgets();
                const widgetEl = document.querySelector(`.widget-item[data-id="${widgets[currentWidgetIndex
                .id}"]`);
                if (widgetEl) widgetEl.classList.add('moving');
            };
            
            
            document.getElementById('setTimer').onclick = () => {
                menu.style.display = 'none';
                const widgets = loadWidgets();
                openTimerSettingModal(widgets[currentWidgetIndex].id);
            };
            
           
            document.getElementById('setAsBackground').onclick = () => {
                menu.style.display = 'none';
                const widgets = loadWidgets();
                const widget = widgets[currentWidgetIndex];
                const imgSrc = WIDGET_BACKGROUNDS[widget.data.imgIndex % WIDGET_BACKGROUNDS.length];
                document.body.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${imgSrc}')`;
                storageSet(STORAGE_KEYS.BACKGROUND, { type: 'image', src: imgSrc });
            };
            
            
            document.getElementById('setSolidBackground').onclick = () => {
                menu.style.display = 'none';
                const bgStyle = isSearchMode 
                    ? 'linear-gradient(135deg, #1a2980, #26d0ce)' 
                    : `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${getRandomBackground()}')`;
                document.body.style.backgroundImage = bgStyle;
                storageSet(STORAGE_KEYS.BACKGROUND, { type: 'solid' });
            };
            
            
            document.getElementById('removeWidget').onclick = () => {
                menu.style.display = 'none';
                const widgets = loadWidgets();
                deleteWidget(widgets[currentWidgetIndex].id);
            };
            
            
            document.addEventListener('click', () => {
                menu.style.display = 'none';
                
                document.querySelectorAll('.widget-item.resizing, .widget-item.moving').forEach(el => {
                    el.classList.remove('resizing', 'moving');
                    if (el.dataset.id) {
                        if (el.classList.contains('resizing')) {
                            updateWidgetSize(el.dataset.id, el.offsetWidth, el.offsetHeight);
                        }
                        if (el.classList.contains('moving')) {
                            updateWidgetPos(el.dataset.id, el.offsetLeft, el.offsetTop);
                        }
                    }
                });
            }, { once: true });
        }

        function createWidgetsContainer() {
            widgetsContainer = document.createElement('div');
            widgetsContainer.className = 'widgets-container';
            document.body.appendChild(widgetsContainer);
        }

        function removeWidgetsContainer() {
            if (widgetsContainer) {
                widgetsContainer.remove();
                widgetsContainer = null;
                
                
                Object.values(timerIntervals).forEach(interval => clearInterval(interval));
                timerIntervals = {};
            }
        }

        
        function enterSearchMode() {
            if (isSearchMode) return;
            isSearchMode = true;
            
            document.getElementById('quickerchTitle').classList.add('pressed');
            const body = document.body;
            const timeDisplay = document.getElementById('time-display');
            const container = document.querySelector('.container');
            
            setTimeout(() => {
                body.classList.remove('time-mode');
                body.classList.add('search-mode');
                
                
                const savedBg = storageGet(STORAGE_KEYS.BACKGROUND);
                if (savedBg && savedBg.type === 'image') {
                    body.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${savedBg.src}')`;
                } else {
                    body.style.backgroundImage = 'linear-gradient(135deg, #1a2980, #26d0ce)';
                }
                
                timeDisplay.style.opacity = '0';
                
               
                searchBox = document.createElement('div');
                searchBox.className = 'search-box';
                
                const currentEngine = loadSearchEngine();
                const dropdown = initSearchEngineDropdown();
                
                searchBox.innerHTML = `
                    <form id="search-form" target="_blank">
                        <div class="search-form" style="position:relative;">
                            <button type="button" class="engine-select-btn" id="engineSelectBtn">
                                <img src="${SEARCH_ENGINES[currentEngine].icon}" alt="${SEARCH_ENGINES[currentEngine].name}">
                            </button>
                            ${dropdown.outerHTML}
                            <input type="text" id="search-input" placeholder="输入关键词搜索..." autocomplete="off" autofocus>
                            <button type="submit" id="search-btn">搜索</button>
                        </div>
                    </form>
                `;
                
                container.appendChild(searchBox);
                
                
                const tabsContainer = document.createElement('div');
                tabsContainer.className = 'tabs-container';
                container.appendChild(tabsContainer);
                renderBookmarks(tabsContainer);
                
                
                createWidgetsContainer();
                renderWidgets();
                
                document.getElementById('widgetsToggle').style.display = 'block';
                
                
                setTimeout(() => {
                    searchBox.classList.add('visible');
                    showGreeting();
                    
                    
                    const engineBtn = document.getElementById('engineSelectBtn');
                    const engineDropdown = document.querySelector('.engine-dropdown');
                    
                    engineBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        engineDropdown.classList.toggle('show');
                    });
                    
                    
                    document.addEventListener('click', () => {
                        if (engineDropdown) engineDropdown.classList.remove('show');
                    });
                    
                    
                    bindSearchEvents();
                }, 100);
            }, 300);
        }

        function exitSearchMode() {
            if (!isSearchMode) return;
            isSearchMode = false;
            
            
            if (searchBox) searchBox.remove();
            searchBox = null;
            
            const tabsContainer = document.querySelector('.tabs-container');
            if (tabsContainer) tabsContainer.remove();
            
            
            removeWidgetsContainer();
            document.getElementById('widgetsToggle').style.display = 'none';
            document.getElementById('widgetsDrawer').classList.remove('open');
            
           
            const body = document.body;
            const timeDisplay = document.getElementById('time-display');
            body.classList.remove('search-mode');
            body.classList.add('time-mode');
            
            const savedBg = storageGet(STORAGE_KEYS.BACKGROUND);
            if (savedBg && savedBg.type === 'image') {
                body.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${savedBg.src}')`;
            } else {
                body.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${getRandomBackground()}')`;
            }
            
            timeDisplay.style.opacity = '1';
            
           
            const title = document.getElementById('quickerchTitle');
            title.classList.remove('pressed');
            title.classList.add('released');
            setTimeout(() => {
                title.classList.remove('released');
            }, 600);
        }

        function bindSearchEvents() {
            const form = document.getElementById('search-form');
            const input = document.getElementById('search-input');
            const currentEngine = loadSearchEngine();
            let selectedEngine = currentEngine;
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const query = encodeURIComponent(input.value.trim());
                if (query) {
                    window.open(SEARCH_ENGINES[selectedEngine].url + query, '_blank');
                }
            });
            
            
            document.querySelectorAll('.engine-dropdown-item').forEach(item => {
                item.addEventListener('click', function() {
                    const engine = this.dataset.engine || this.querySelector('img').alt;
                    if (engine && SEARCH_ENGINES[engine]) {
                        selectedEngine = engine;
                        saveSearchEngine(engine);
                    }
                });
            });
        }

       
        function init() {
            
            const savedBg = storageGet(STORAGE_KEYS.BACKGROUND);
            if (savedBg && savedBg.type === 'image') {
                document.body.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${savedBg.src}')`;
            } else {
                document.body.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('${getRandomBackground()}')`;
            }
            
            
            updateTimeDisplay();
            setInterval(updateTimeDisplay, 1000);
            
            
            document.getElementById('widgetsToggle').style.display = 'none';
            document.getElementById('greetingToggle').checked = loadGreetingSetting();
            
           
            document.getElementById('quickerchTitle').addEventListener('click', () => {
                isSearchMode ? exitSearchMode() : enterSearchMode();
            });
            
            
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.add('show');
            });
            
            
            document.getElementById('closeSettingsBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.remove('show');
            });
            
            
            document.getElementById('greetingToggle').addEventListener('change', (e) => {
                saveGreetingSetting(e.target.checked);
            });
            
            
            document.getElementById('widgetsToggle').addEventListener('click', () => {
                document.getElementById('widgetsDrawer').classList.toggle('open');
            });
            
            
            document.querySelectorAll('.widget-preview').forEach(preview => {
                preview.addEventListener('click', () => {
                    if (isSearchMode && widgetsContainer) {
                        const widgetType = preview.dataset.type;
                        saveWidget({ type: widgetType });
                        document.getElementById('widgetsDrawer').classList.remove('open');
                    }
                });
            });
            
            
            document.getElementById('confirmBtn').addEventListener('click', () => {
                const url = document.getElementById('tabUrlInput').value.trim();
                if (url) {
                    const fullUrl = url.startsWith('http') ? url : `https://${url}`;
                    try {
                        new URL(fullUrl);
                        const urlObj = new URL(fullUrl);
                        saveBookmark({
                            title: urlObj.hostname.replace('www.', ''),
                            url: fullUrl,
                            icon: `https://www.google.com/s2/favicons?domain=${urlObj.hostname}&sz=64`
                        });
                        document.getElementById('tabUrlInput').value = '';
                        document.getElementById('addTabModal').classList.remove('show');
                    } catch (e) {
                        alert('无效的URL，请输入正确的网址');
                    }
                }
            });
            
            
            document.getElementById('cancelBtn').addEventListener('click', () => {
                document.getElementById('addTabModal').classList.remove('show');
            });
            
            
            document.getElementById('saveEditBtn').addEventListener('click', () => {
                const url = document.getElementById('editTabUrlInput').value.trim();
                if (url && currentEditIndex >= 0) {
                    const fullUrl = url.startsWith('http') ? url : `https://${url}`;
                    updateBookmark(currentEditIndex, fullUrl);
                    document.getElementById('editTabUrlInput').value = '';
                    document.getElementById('editTabModal').classList.remove('show');
                    currentEditIndex = -1;
                }
            });
            
            
            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                document.getElementById('editTabModal').classList.remove('show');
                currentEditIndex = -1;
            });
            
            
            document.getElementById('confirmTimerBtn').addEventListener('click', () => {
                const widgetId = document.getElementById('timerModal').dataset.widgetId;
                const seconds = parseInt(document.getElementById('timerSecondsInput').value) || 0;
                
                if (seconds > 0 && seconds <= 3600) {
                    const autoStart = document.getElementById('confirmTimerBtn').dataset.autoStart === 'true';
                    updateTimerData(widgetId, seconds, autoStart);
                    
                    const display = document.querySelector(`.widget-item[data-id="${widgetId}"] .timer-display`);
                    const startBtn = document.querySelector(`.widget-item[data-id="${widgetId}"] .timer-btn.start`);
                    
                    if (display) display.textContent = formatTime(seconds);
                    if (startBtn) {
                        startBtn.textContent = autoStart ? '暂停' : '开始';
                        if (autoStart) startBtn.click();
                    }
                    
                    document.getElementById('timerModal').classList.remove('show');
                    document.getElementById('timerSecondsInput').value = '';
                    delete document.getElementById('confirmTimerBtn').dataset.autoStart;
                } else {
                    alert('请输入1-3600之间的秒数');
                }
            });
            
            
            document.getElementById('cancelTimerBtn').addEventListener('click', () => {
                document.getElementById('timerModal').classList.remove('show');
                document.getElementById('timerSecondsInput').value = '';
                delete document.getElementById('confirmTimerBtn').dataset.autoStart;
            });
            
           
            const modals = ['settingsModal', 'addTabModal', 'editTabModal', 'timerModal'];
            modals.forEach(id => {
                const modal = document.getElementById(id);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('show');
                        if (id === 'timerModal') {
                            delete document.getElementById('confirmTimerBtn').dataset.autoStart;
                        }
                    }
                });
            });
            
            
            if (isSearchMode) {
                createWidgetsContainer();
                renderWidgets();
            }
        }

        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
